---
title: "Shapefile prep"
output: html_document
---

**Shapefile downloaded from ESRI, created by David Smith, Readlands Univ.** 

https://univredlands.maps.arcgis.com/home/webmap/viewer.html?useExisting=1&layers=335a6b9b0f3248e7bf7d3938dafd62c4&layerId=0

```{r}
library(tidyverse)
library(sf)
library(here)
library(mapview)
library(mapedit)
library(leaflet)
library(rgeos)#needed for making a hole but there may be a better way to do this using sf
library(raster)


#file path setup

goal     <- 'lsp'
scenario <- 'v2020'
dir_anx       <- file.path(dir_M, 'git-annex/globalprep') 
dir_goal      <- file.path(here('prep/bd',goal, scenario))
dir_goal_anx  <- file.path(dir_anx, goal, scenario)#this is to get the wdpa raster
dir_github    <- '~/github/tet-prep'
```

##Creating polygons representing the motus

Read in the data and check it out
```{r}

tet_shore_a <- st_read(dsn = here("spatial/raw_data_"), layer = "shorelines2011")

mapview(tet_shore_a, zcol = "type") #Appears to be missing some of the lines?
```

Try the other data file that Dave sent

```{r}
tet_shore <- st_read(dsn = here("spatial/raw_data_"), layer = "shorelines2011_2")

mapview(tet_shore) #looks like the same

```

Still missing lines - try using `mapedit` to add lines

```{r}

#try the way I found online with editmap

tet_lines_miss <- mapview(tet_shore) %>%
  editMap("tet_shore_2")


```

Ok, weirdly when we open this in editMap it looks like all the lines are there - maybe if I just run lines to polygons it will work fine. Try that below:

```{r}

#use "st_polygonize"

# tet_motus <- st_polygonize(tet_shore)
# 
# mapview(tet_motus) 
# 
# #this did not work, try union:
# 
# tet_motus <- st_collection_extract(st_polygonize(st_union(tet_shore)))
# 
# mapview(tet_motus)

#another variation:

tet_motus <- st_cast(st_polygonize(st_union(tet_shore)))

mapview(tet_motus)

#yay this worked! class is "sfc_polygon" "sfc"

#transform to Mollweide

tet_motus_xformed <- st_transform(tet_motus, crs = '+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs')

```

Write out shapefile:
**note** this data has no info, may want to add island identifiers?

```{r}

st_write(tet_motus, "tet_motus.shp" ) #moved this to shp

st_write(tet_motus_xformed, "tet_motus_xformed.shp")
```


##Creating shapefiles for marine space

Next step is to create shapefiles representing marine space. 

1. lagoon area
2. 3 nautical miles in all directions from the outside of the motus

```{r}

#apply a 3nm buffer, and use union to create on shapefile

tet_buffer_3nm <- st_union(st_buffer(tet_motus_xformed, 5556)) 
  #question how to make sure that dist is in the right units?

#tet_ocean <- st_difference(tet_buffer, tet_motus_xformed) #this didn't work, maybe intersection?


mapview(tet_buffer)+
  mapview(tet_motus_xformed, col.regions = "green")

```

Write out buffer shapefile
```{r}
st_write(tet_buffer_3nm, "tet_buffer_3nm.shp")


```

Will need a raster version for layer prep (this code is repated in lsp prep, since I think it shows that the raster does not have :

```{r}
#source wdpa raster
rast_wdpa <- raster::raster(file.path(dir_goal_anx, 'rast', 'wdpa_2020_moll_500m.tif')) #note: the numbers for this are 2019, does that seem right?

#to convert into raster needs to be in an sp object instead sfc_POLYGON
tet_buffer_3nm_sp <- as(tet_buffer_3nm,"Spatial")

crop <- crop(rast_wdpa, extent(tet_buffer_3nm_sp), snap="out")
tet_3nm_rast <- rasterize(tet_buffer_3nm_sp, crop)

#mask wdpa if needed:

wdpa_mask <- mask(x=crop, mask=tet_3nm_rast) #I think the warning you get here tells you that it doesn't have any protected areas/.

plot(tet_3nm_rast) #not sure where these values came from 
```

