---
title: "Tetiaroa RRedlist"
author: "Maddie Berger"
date: "6/4/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rredlist)
library(tidyverse)
library(dplyr)
library(raster)
library(here)
library(janitor)
source(here('workflow/R/common.R'))

api_file <- file.path(dir_M, 'git-annex/globalprep/spp', 
                      'api_key_gc.csv')
api_key <- scan(api_file, what = 'character')

'%!in%' <- function(x,y)!('%in%'(x,y)) #define helpful filtering function
```
**Summary** Script for initial pull red list categorizations using list from Tetiaroa Society 

##Filtering Redlist by Location (French Polynesia)
Get US Minor French Polynesia species 
```{r}
spp_country_url <- 'http://apiv3.iucnredlist.org/api/v3/country/getspecies/id/%s?token=%s'
# 
# /api/v3/country/getspecies/:country?token='YOUR TOKEN'
countries <- rl_countries(key = api_key)$results
#UM is United States Minor Outlying Islands country code
# UM species risks
spp_um <- rl_sp_country('UM', key = api_key)$result %>%
  mutate(country_code = "UM") %>%
  rename("iucn_sid" = "taxonid")
##PF is French Polynesia country code
## French Polynesia Species risks
spp_fp <- rl_sp_country('PF', key = api_key)$result %>%
  mutate(country_code = "PF") %>%
  rename("iucn_sid" = "taxonid") %>% 
  mutate(
    scientific_name = str_to_lower(scientific_name)
  )

```

Filter out species we want for Tetiaroa:
```{r}
#read in csv with list of tet species

tet_species <- read_csv(here("./prep/sp/ico/v2020/raw_data", "tet_species.csv"))%>%
  clean_names() %>% 
  mutate(
    scientific_name = str_to_lower(scientific_name)
  )

tet_species_iucn <- spp_fp %>% 
  filter(scientific_name %in% tet_species$scientific_name)

tet_species_iucn_fp <- inner_join(tet_species_iucn,tet_species, by = "scientific_name") %>%  dplyr::select(iucn_sid, scientific_name,category.x,name,ico)

```

Check to see if they were all there:
```{r}

missing_spp <- setdiff(tet_species$scientific_name, tet_species_iucn$scientific_name)

tet_species_missing_fp <- tet_species %>% 
  filter(scientific_name %in% missing_spp)
```

Seems like the French Polynesia list is missing some species that are found on Tetiaroa
https://rdrr.io/cran/rredlist/man/rl_occ_country.html

```{r}

#test hawksbill turtle, which is critically endangered

rl_occ_country("Eretmochelys imbricata", key = api_key) 
#can see that FP isn't on here, even though the range maps shows it occurs there


```

##Part 2: Using the entire IUCN dataset, instead of filtering by country

Decided to start here instead of making a bunch of different datasets and then joining them. Seems simpler. 

```{r}
## get a dataframe of all iucn redlist species

out <- rl_sp(all = TRUE, key = api_key)

all_df <- do.call(rbind, lapply(out, "[[", "result")) #creates data frames from each item in the large list in `out` and then binds them

all_df_comp <- all_df %>%
  dplyr::select(-infra_rank, -infra_name) %>%
    dplyr::rename(iucn_sid = taxonid, sciname = scientific_name) %>% 
    setNames(names(.) %>%
               stringr::str_replace('_name', '')) %>% 
  mutate(
    sciname = str_to_lower(sciname)
  )


#filter large df by the all the scientific names vector

tet_listed <- all_df_comp %>% 
filter(sciname %in% tet_species$scientific_name)

#this only has 86 obs, improvement from before

not_in_iunc <- setdiff(tet_species$scientific_name, tet_listed$sciname) 

no_record <- tet_species %>% 
  dplyr::filter(scientific_name %in% not_in_iunc) #49 observations

#this seems really unlikely. something might be up with spelling?


```

So far, have created the following dfs:
- `tet_species_iucn_fp` is all the species that matched what was pulled from the IUCN French Polynesia list
- `tet_species_missing_fp` is all the species that were missing from the IUCN French Polynesia list but were included in Tetiaroa's species list
- `tet_listed` is all the species that were matched using the entire IUCN dataset, which gets us up to 86 - a bunch of duplicates though, need to filter out by range
- `no_record` includes all the species we still can't match. This list is probably a result of differeces in spelling as there are many species on there that should be in the IUCN, like humpback whale, spotted eagle ray, and olive ridley's turtle. 

##Working with `tet_listed` dataset

This dataset needs to be cleaned up and filtered out for the subpopulations we are interested in, since the IUCN category differs for them. 

```{r}

tet_lc <- tet_listed %>% 
  dplyr::select(iucn_sid, sciname, population, category)

#find the duplicate species

tet_listed_dup <- tet_lc[duplicated(tet_lc$sciname),]

#try by just filtering out the ones with key words in the population columns - these are the versions we want!

test <- tet_lc[grepl("South Pacific", tet_lc$population) | grepl("Hawaiian", tet_lc$population) | grepl("Asia", tet_lc$population)| grepl("East Pacific", tet_lc$population) ,]

#now filter out the duplicated species from the tet_lc dataset, and bind the test data set to it (probably a better way of doing this)

tet_lc_2 <- tet_lc %>% 
  filter(sciname %!in% tet_listed_dup$sciname)

tet_listed_clean <- bind_rows(tet_lc_2, test)

#61 matched species

tet_listed_info <- tet_species %>% 
  dplyr::select(name, sciname = scientific_name)

tet_listed_ico <- inner_join(tet_listed_info, tet_listed_clean, by = "sciname")

```

###Working with `no_record` dataset

Now we can work on the other batch, the ones that did NOT match. While 61 iconic species is plenty, there are a few key species we want to add that seem like obvious oversights. These include:  

- **Humpback whale**: iucn spells it "megaptera novaeangliae", which is the same? IUCN id = 132832
- **Melon headed whale**: misspelled IUCN id = 16564
- **Olive Ridley sea turtle**: misspelled IUCN id = 11534
- **Clown fish**: correct spelling, species specific to Tetiaroa not included in IUCN data set
- **Spotted eagle ray**: spelled "aetobatus narinari", IUCN ID = 39415
- **Pink whipray**: not found in IUCN data set
- **Strawberry hermit crab**: spelled correctly, not included
- **Christmas tree worm**: not included

```{r}

#create vector of the ids we want
iucn_sid <- c(132832, 16564, 11534, 39415) 
names <- c("humpback whale", "melon-headed whale", "olive ridley sea turtle", "spotted eagle ray")

miss_info <- data.frame(iucn_sid,names)

#filter entire IUCN dataset, match columns to tet_listed_clean
missing_ico <- all_df_comp %>% 
  filter(iucn_sid %in% miss_ids) %>% 
  dplyr::select(iucn_sid, sciname, population, category)

#join to common names

missing_ico_clean <- inner_join(miss_info,missing_ico, by = "iucn_sid") %>% 
  dplyr::select(name = names, sciname, iucn_sid, population, category)
```

Last step is to bind missing iconic species to the listed ones: 

```{r}

tet_ico_all <- bind_rows(tet_listed_ico,missing_ico_clean) %>% 
  mutate(
    name = str_to_lower(name)
  )

```



