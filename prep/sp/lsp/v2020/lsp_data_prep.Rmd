---
title: 'OHI Tetiaroa: Lasting Special Places'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output:
  html_document:
    highlight: haddock
    includes:
      in_header: '../../../workflow/templates/ohi_hdr.html' #this doesn't exist yet
    number_sections: yes
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

# Summary

From Halpern et al. 2012 supplemental info: 

> The ‘Lasting Special Places’ sub-goal focuses instead on those geographic locations that hold particular value for aesthetic, spiritual, cultural, recreational or existence reasons57. This sub-goal is particularly hard to quantify. Ideally one would survey every community around the world to determine the top list of special places, and then assess how those locations are faring relative to a desired state (e.g., protected or well managed). The reality is that such lists do not exist. Instead, we assume areas that are protected represent these special places (i.e. the effort to protect them suggests they are important places).

> Clearly this is an imperfect assumption but in many cases it will be true. Using lists of protected areas as the catalogue of special places then creates the problem of determining a reference condition. We do not know how many special places have yet to be protected, and so we end up having all identified special places also being protected. To solve this problem we make two important assumptions. First, we assume that all countries have roughly the same percentage of their coastal waters and coastline that qualify as lasting special places. In other words, they all have the same reference target (as a percentage of the total area). Second, we assume that the target reference level is 30% of area protected.

The model for this goal considers the inland coastal zone (up to 1 km inland) independently from, and equally weighted with, the offshore coastal zone (up to 3 nm offshore).  The status for this goal is calculated as:

$$X_{LSP} = \frac{\left(\frac{Area_{P}}{Area_{P_{ref}}} + \frac{Area_{MPA}}{Area_{MPA_{ref}}}\right)}{2}$$

where: 

* $Area_{P}$ = Protected area for inland 1 km buffer
* ${Area_{P_{ref}}}$ = Reference value for inland protected area
* $Area_{MPA}$ = Marine protected area for offshore 3 nm buffer
* ${Area_{MPA_{ref}}}$ = Reference value for marine protected area within offshore 3 nm buffer
* $Ref$ = 30% of total area within buffer zone is protected



***

# Setup

```{r, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```


```{r setup, echo = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE)

library(raster)
library(sf)
library(tidyverse)
library(here)

source(here('workflow/R/common.R'))

goal     <- 'lsp'
scenario <- 'v2020'
dir_anx       <- file.path(dir_M, 'git-annex/globalprep') 
dir_goal      <- file.path(here('prep/sp',goal, scenario))
dir_goal_anx  <- file.path(dir_anx, goal, scenario)
dir_github    <- '~/github/tet-prep'


```

# Methods

There are three main areas that can be protected:
- land area of the motus
- the lagoon
- 3nm offshore

All three will be weighted evenly, unless discussions with 4site suggest something else. Tetiaroa is a private island, so all of the land will be considered 100% protected, meaning the 1 km onshore protected areas will receive a score of 1. We know the lagoon is 50% protected, so that will receive a score of 0.5. What we need to determine is if there are any known protected areas in the 3nm buffer area. 

Two output files are required: 

 * total area for offshore 3 nm and inland 1 km
 * protected area for offshore 3 nm and inland 1 km

 * rgn_area_offshore3nm with the following columns: rgn_id, area ($km^2$)   
 * lsp_prot_area_offshore3nm with the following columns: rgn_id, year, a_prot_3nm ($km^2$)

***

## Compute zonal statistics for 3nm offshore motus - NOTE TO DELETE THIS IF NOT NECESSARY

Comparing the global WDPA raster to the 3 nautical miles offshore and 1 km inland rasters, we can tally the protected area within each region and compare to the total area within each region.  Note each cell is 500 m x 500 m, so area is .25 km^2^, but since we are simply calculating a ratio, this cancels out.

``` {r lsp_zonal_stats, eval = FALSE}

zonal_3nm =  file.path(dir_goal, 'int', 'zonal_stats_3nm.csv') #file path for finished cross tabulation

### point to the 3nm buffer created in the spatial prep - SHAPEFILE?
tet_rgn_offshore3nm <- file.path(dir_github, '/spatial/shp/tet_buffer_3nm') 

##global wdpa raster
rast_wdpa <- raster::raster(file.path(dir_goal_anx, 'rast', 'wdpa_2020_moll_500m.tif'))

# rgn_rast_list <- c(
#   'zonal_3nm' = file.path(dir_zones, 'rgn_offshore3nm_mol_500mcell.tif'),
#   'zonal_1km' = file.path(dir_zones, 'rgn_inland1km_mol_500mcell.tif'),
#   'zonal_eez' = file.path(dir_zones, 'rgn_eez_mol_500mcell.tif'))

### Remove all files in `int` if it's the first time working through this data prep for this assessment
### Filters out finished zonal files: if zonal files don't exist yet, they will be created (comment out to recalculate)
zonal_files_to_run <- zonal_files[!file.exists(zonal_files)]
rgn_rast_list <- rgn_rast_list[!file.exists(zonal_files)]


  ### NOTE: The crosstab function returns this warning - does it affect the
  ### outcomes, or does the function coerce the correct outcome?
      # Warning message:
      # In FUN(X[[i]], ...) : integer overflow - use sum(as.numeric(.))
  ### zonal() wouldn't work since we want to track the frequency of each
  ### year value within each rgn_id value.
  
  lsp_crosstab <- function(rgn_rast_file, rast_values) {
    rgn_rast <- raster::raster(rgn_rast_file) #turns shapefile into raster?
    message('Cross tabulating ', rgn_rast_file)
    rast_df <- raster::crosstab(rast_values, rgn_rast, useNA = TRUE, progress = 'text') %>%
      as.data.frame() %>%
      setNames(c('year', 'rgn_id', 'n_cells')) %>%
      mutate(year   = as.integer(as.character(year)),
             rgn_id = as.integer(as.character(rgn_id))) %>%
      arrange(rgn_id, year)
  
    return(rast_df)
  }
  
  
### Processing & saving zonal statistics for a single raster 
x <- lsp_crosstab(rgn_rast_list[1], rast_values = rast_wdpa) #~20 minutes to run #3nm

```

Once the WDPA raster is cross-tabulated against the OHI region rasters (both 3 nm offshore and 1 km inland) we have the number of protected cells, identified by year of protection, within each region.  NA values are unprotected cells.

### Summary of zonal stats dataframes (3 nm offshore):

``` {r, eval = FALSE}
stats_3nm <- read_csv(zonal_files['zonal_3nm'])
print(summary(stats_3nm))

```

### Summary of zonal stats dataframes (entire EEZ):

``` {r}
stats_eez <- read_csv(zonal_files['zonal_eez'])
print(summary(stats_eez))
```

***
Above not working great - code below shows that the wdpa raster probably does not intersect with the 3nm raster

```{r}
#source wdpa raster
rast_wdpa <- raster::raster(file.path(dir_goal_anx, 'rast', 'wdpa_2020_moll_500m.tif')) #note: the numbers for this are 2019, does that seem right?

#to convert into raster needs to be in an sp object instead sfc_POLYGON
tet_buffer_3nm_sp <- as(tet_buffer_3nm,"Spatial")

crop <- crop(rast_wdpa, extent(tet_buffer_3nm_sp), snap="out")
tet_3nm_rast <- rasterize(tet_buffer_3nm_sp, crop)

#mask wdpa if needed:

wdpa_mask <- mask(x=crop, mask=tet_3nm_rast) #I think the warning you get here tells you that it doesn't have any protected areas since this is empty.

plot(tet_3nm_rast) #not sure where these values came from 
```

***

## Calculate region areas 

Total area
``` {r calc_rgn_area, eval = FALSE}

#buffered area = total area of offshore and onshore we are interested in
calc_area_3nm <- st_read(file.path(dir_github, 'spatial/shp'), layer = 'tet_buffer_3nm') %>% 
  mutate(area_m2 = st_area(.),
         area_km2 = area_m2/1000000) %>% 
  separate(area_km2, into = c("area_km2", "units"), sep = " ") %>% 
  dplyr::select(-area_m2, -units)

area_3nm <- as.numeric(calc_area_3nm$area_km2)

#create data frame

rgn_area_offshore_3nm <- data.frame(rgn_id = 1, area = area_3nm)

#export to outputs folder

write_csv(rgn_area_offshore_3nm, file.path(dir_github, 'prep/sp/lsp/v2020/output/rgn_area_area_offshore3nm'))
```


Protected area
``` {r calc_prot_area, eval = FALSE}
#motus - these are all protected
#calculate area
area_motus <- st_read(file.path(dir_github, 'spatial/shp'), layer = 'tet_motus') %>% 
  mutate(area_m2 = st_area(.),
         area_km2 = area_m2/1000000) %>% 
  separate(area_km2, into = c("area_km2", "units"), sep = " ") %>% 
  dplyr::select(-area_m2, -units)

#sum to find total

area_motus_tot <- sum(as.numeric(area_motus$area_km2))

#create data frame -not sure when no take zone was est so will just use global range 2000 - 2019

years <- seq(2000,2019,1)

lsp_prot_area_1km <- data.frame(rgn_id = rep(1, length(years)), 
                                year = years, 
                                area = rep(area_motus_tot, length(years))) #missing years

#lagoon - half of this is protected with a no take zone. We'll come back to this

write_csv(lsp_prot_area_1km, file.path(dir_github, 'prep/sp/lsp/v2020/output/lsp_prot_area_1km'))

```


***

## Write out layers

From the protected area files, write out the individual layers ready for the Toolbox[TM]. 

* total area for offshore 3 nm and inland 1 km
* protected area for offshore 3 nm and inland 1 km

``` {r write_layers, eval = FALSE}

prot_3nm <- read_csv(file.path(dir_goal, 'int', 'area_protected_3nm.csv')) %>%
  rename(area = a_tot_km2,
         a_prot_3nm = a_prot_km2)
prot_1km <- read_csv(file.path(dir_goal, 'int', 'area_protected_1km.csv')) %>%
  rename(area = a_tot_km2,
         a_prot_1km = a_prot_km2)

# write_lsp_layer <- function(df, layers, layername) {
#   df1 <- df[ , c('rgn_id', layers)] %>%
#     filter(rgn_id <= 250) %>%
#     distinct()
#   write_csv(df1, file.path(dir_goal, 'output', paste0(layername, '.csv')))
# }

a_tot_3nm <- write_lsp_layer(prot_3nm, 'area', 'rgn_area_offshore3nm')
a_tot_1km <- write_lsp_layer(prot_1km, 'area', 'rgn_area_inland1km')

a_prot_3nm <- write_lsp_layer(prot_3nm, c('year', 'a_prot_3nm'), 'lsp_prot_area_offshore3nm')
a_prot_1km <- write_lsp_layer(prot_1km, c('year', 'a_prot_1km'), 'lsp_prot_area_inland1km')

```

## Creating layer with scores

Above code useful if we end up wanting to be more precise in our scoring, but without the exact boundaries of the lagoon we cannot be totally accurate. For now, create a layer that assigns scores to our three "regions" (lagoon, land and open ocean) based on what we know from conversations with Frank and Neil. 

1. land: all of it is protected in that is a private island 
2. lagoon: half of it is protected as a no take zone
3. ocean: as far as we know, there are no reserves that intersect wih the area that is 3nm outside the islands 

```{r}

year <- seq(2000,2019,1)

rgn_1 <- data.frame(
  rgn_id = rep(1, length(year)),
  year = year,
  status = rep(1, length(year))
)

rgn_2 <- data.frame(
  rgn_id = rep(2, length(year)),
  year = year,
  status = rep(0.5, length(year))
)

rgn_3 <- data.frame(
  rgn_id = rep(3, length(year)),
  year = year,
  status = rep(0, length(year))
)

#bind them all together

lsp_status_scores <- bind_rows(rgn_1,rgn_2,rgn_3)

#write to output folder 

write_csv(lsp_status_scores, file.path(dir_goal, "output/lsp_status.csv"))

```

