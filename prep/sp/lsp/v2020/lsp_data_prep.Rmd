---
title: 'OHI Tetiaroa: Lasting Special Places'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output:
  html_document:
    highlight: haddock
    includes:
      in_header: '../../../workflow/templates/ohi_hdr.html' #this doesn't exist yet
    number_sections: yes
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

## Summary

The methods for global are as follows, from Halpern et al. 2012 supplemental info: 

> The ‘Lasting Special Places’ sub-goal focuses instead on those geographic locations that hold particular value for aesthetic, spiritual, cultural, recreational or existence reasons57. This sub-goal is particularly hard to quantify. Ideally one would survey every community around the world to determine the top list of special places, and then assess how those locations are faring relative to a desired state (e.g., protected or well managed). The reality is that such lists do not exist. Instead, we assume areas that are protected represent these special places (i.e. the effort to protect them suggests they are important places).

> Clearly this is an imperfect assumption but in many cases it will be true. Using lists of protected areas as the catalogue of special places then creates the problem of determining a reference condition. We do not know how many special places have yet to be protected, and so we end up having all identified special places also being protected. To solve this problem we make two important assumptions. First, we assume that all countries have roughly the same percentage of their coastal waters and coastline that qualify as lasting special places. In other words, they all have the same reference target (as a percentage of the total area). Second, we assume that the target reference level is 30% of area protected.

The model for this goal considers the inland coastal zone (up to 1 km inland) independently from, and equally weighted with, the offshore coastal zone (up to 3 nm offshore).  The status for this goal is calculated as:

$$X_{LSP} = \frac{\left(\frac{Area_{P}}{Area_{P_{ref}}} + \frac{Area_{MPA}}{Area_{MPA_{ref}}}\right)}{2}$$

where: 

* $Area_{P}$ = Protected area for inland 1 km buffer
* ${Area_{P_{ref}}}$ = Reference value for inland protected area
* $Area_{MPA}$ = Marine protected area for offshore 3 nm buffer
* ${Area_{MPA_{ref}}}$ = Reference value for marine protected area within offshore 3 nm buffer
* $Ref$ = 30% of total area within buffer zone is protected

Because Tetiaroa is such a small area, we will deviate slightly from these methods. First, instead of just calculating protected area within 1km of the shore, we will treat all land areas as coastal land on Tetiaroa, since most motus (individual islands) are not wider than 1 km anyway. Second, instead of created a buffer of 3nm and treating that as all one area, we will split up the marine area into two categories: lagoon area, and the area extending outwards 3nm from each motu ("offshore"). 

Lastly, we will adjust what we define as "area protected", expressed in terms of stakeholder engagement and number of parties involved in management, in addition to actual protected areas established. This is because we do not think that just because the island is private, it is truly protected in the same way a protected area would be. While it is unlikely that the company that owns Tetiaroa would develop it further, they have full ability to do it, or sell to another party that would. From FourSite's point of view, and taking into account the Tetiaroa's Society's long term goal of making Tetiaroa a nature sanctuary, this still poses a threat. Therefore, we 

Below are the three main areas, with the corresponding ownership / management information: 

| Area | Ownership / Management |
| :---- | :----------- |
| All motus | SA Frangiapini |
| Onetahi & Honuea | SA Frangiapini and Beachcomber | 
| Lagoon | FP Government, Tetiaroa Society |
| 3nm offshore | FP Government|


All three will be weighted evenly, unless discussions with Four site suggest something else. 



Two output files are created: 

 * total area for offshore 3 nm and inland 1 km
 * protected area for offshore 3 nm and inland 1 km

 * rgn_area_offshore3nm with the following columns: rgn_id, area ($km^2$)   
 * lsp_prot_area_offshore3nm with the following columns: rgn_id, year, a_prot_3nm ($km^2$)


***

## Setup

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE)

library(raster)
library(sf)
library(tidyverse)
library(here)

source(here('workflow/R/common.R'))

goal     <- 'lsp'
scenario <- 'v2020'
dir_goal      <- file.path(here('prep/sp',goal, scenario))
dir_goal_anx  <- file.path(dir_anx, goal, scenario)
dir_github    <- '~/github/tet-prep'


```

## Methods

First, we'll check the WDPA raster and make sure there aren't any MPAs that fall within our 3nm buffer. 

```{r, include=FALSE}
#source wdpa raster
rast_wdpa <- raster::raster(file.path(dir_goal_anx, 'rast', 'wdpa_2020_moll_500m.tif')) #note: the numbers for this are 2019, does that seem right?

#to convert into raster needs to be in an sp object instead sfc_POLYGON
tet_buffer_3nm_sp <- as(tet_buffer_3nm,"Spatial")

crop <- crop(rast_wdpa, extent(tet_buffer_3nm_sp), snap="out")
tet_3nm_rast <- rasterize(tet_buffer_3nm_sp, crop)

#mask wdpa if needed:

wdpa_mask <- mask(x=crop, mask=tet_3nm_rast) #I think the warning you get here tells you that it doesn't have any protected areas since this is empty.

plot(tet_3nm_rast) #not sure where these values came from 
```

***

## Calculate region areas 

Total area
``` {r calc_rgn_area, eval = FALSE}

#buffered area = total area of offshore and onshore we are interested in
calc_area_3nm <- st_read(file.path(dir_github, 'spatial/shp'), layer = 'tet_buffer_3nm') %>% 
  mutate(area_m2 = st_area(.),
         area_km2 = area_m2/1000000) %>% 
  separate(area_km2, into = c("area_km2", "units"), sep = " ") %>% 
  dplyr::select(-area_m2, -units)

area_3nm <- as.numeric(calc_area_3nm$area_km2)

#create data frame

rgn_area_offshore_3nm <- data.frame(rgn_id = 1, area = area_3nm)

#export to outputs folder

write_csv(rgn_area_offshore_3nm, file.path(dir_github, 'prep/sp/lsp/v2020/output/rgn__area_offshore3nm'), append = FALSE)
```


Protected area
``` {r calc_prot_area, eval = FALSE}
#motus - these are all protected
#calculate area
area_motus <- st_read(file.path(dir_github, 'spatial/shp'), layer = 'tet_motus') %>% 
  mutate(area_m2 = st_area(.),
         area_km2 = area_m2/1000000) %>% 
  separate(area_km2, into = c("area_km2", "units"), sep = " ") %>% 
  dplyr::select(-area_m2, -units)

#sum to find total

area_motus_tot <- sum(as.numeric(area_motus$area_km2))

#create data frame -not sure when no take zone was est so will just use global range 2000 - 2019

years <- seq(2000,2019,1)

lsp_prot_area_1km <- data.frame(rgn_id = rep(1, length(years)), 
                                year = years, 
                                area = rep(area_motus_tot, length(years))) #missing years

#lagoon - half of this is protected with a no take zone. We'll come back to this

write_csv(lsp_prot_area_1km, file.path(dir_github, 'prep/sp/lsp/v2020/output/lsp_prot_area_1km'))

```


***

## Write out layers

From the protected area files, write out the individual layers ready for the Toolbox[TM]. 

* total area for offshore 3 nm and inland 1 km
* protected area for offshore 3 nm and inland 1 km

``` {r write_layers, eval = FALSE}

prot_3nm <- read_csv(file.path(dir_goal, 'int', 'area_protected_3nm.csv')) %>%
  rename(area = a_tot_km2,
         a_prot_3nm = a_prot_km2)
prot_1km <- read_csv(file.path(dir_goal, 'int', 'area_protected_1km.csv')) %>%
  rename(area = a_tot_km2,
         a_prot_1km = a_prot_km2)

# write_lsp_layer <- function(df, layers, layername) {
#   df1 <- df[ , c('rgn_id', layers)] %>%
#     filter(rgn_id <= 250) %>%
#     distinct()
#   write_csv(df1, file.path(dir_goal, 'output', paste0(layername, '.csv')))
# }

a_tot_3nm <- write_lsp_layer(prot_3nm, 'area', 'rgn_area_offshore3nm')
a_tot_1km <- write_lsp_layer(prot_1km, 'area', 'rgn_area_inland1km')

a_prot_3nm <- write_lsp_layer(prot_3nm, c('year', 'a_prot_3nm'), 'lsp_prot_area_offshore3nm')
a_prot_1km <- write_lsp_layer(prot_1km, c('year', 'a_prot_1km'), 'lsp_prot_area_inland1km')

```

## Creating layer with scores

Above code useful if we end up wanting to be more precise in our scoring, but without the exact boundaries of the lagoon we cannot be totally accurate. For now, create a layer that assigns scores to our three "regions" (lagoon, land and open ocean) based on what we know from conversations with Frank and Neil. 

1. land: all of it is protected in that is a private island 
2. lagoon: half of it is protected as a no take zone
3. ocean: as far as we know, there are no reserves that intersect wih the area that is 3nm outside the islands 

```{r}

year <- seq(2014,2020,1)

#create land layer
land_status <- data.frame(
  rgn_id = rep(1, length(year)),
  year = year,
  status = rep(1, length(year))
)

write.csv(land_status %>% select(region_id = rgn_id, year, status), file = "~/github/tet-scores/region/layers/lsp_land_status.csv", row.names = FALSE)

#create lagoon layer
lagoon_status <- data.frame(
  rgn_id = rep(2, length(year)),
  year = year,
  status = rep(0.5, length(year))
)

write.csv(lagoon_status %>% select(region_id = rgn_id, year, status), file = "~/github/tet-scores/region/layers/lsp_lagoon_status.csv", row.names = FALSE)

#create offshore layer
offshore_status <- data.frame(
  rgn_id = rep(3, length(year)),
  year = year,
  status = rep(0, length(year))
)

write.csv(offshore_status %>% select(region_id = rgn_id, year, status), file = "~/github/tet-scores/region/layers/lsp_offshore_status.csv", row.names = FALSE)
```


``` {r}

#bind them all together - if we want it

lsp_status_scores <- bind_rows(rgn_1,rgn_2,rgn_3)

#write to output folder 

write_csv(lsp_status_scores, file.path(dir_goal, "output/lsp_status_all.csv"))

```

Now make a single layer with information combined into average. This is where the weighting can be adjusted if needed, ie if we decide the lagoon is more important than the land. This should also be adjusted if we want to change the years. Right now, overall score is 0.5 since that is the average of the all three subregions. 


Note: fix notation, its kind of confusing right now. Also, for now this step will be in the toolbox.

```{r}


lsp_status_avg <- data.frame(
  rgn_id = rep(1,length(year)),
  year = year,
  status = rep(0.5, length(year))
) %>% 
  filter(year > 2013)

write_csv(lsp_status_avg, file.path(dir_goal, "output/lsp_status_avg.csv"))

```

