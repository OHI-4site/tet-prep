---
title: "OHI Tetiaroa: Coral Reef Habitat"
output:
  html_document:
    highlight: haddock
    includes:
      in_header: '~/github/tet-prep/workflow/templates/tet_hdr.html' 
    number_sections: yes
    theme: cerulean
    toc: yes
---

#Summary

This script pulls more up to date coral data from the Living Oceans Foundation French Polynesia report, which was published in 2017. This will be used to assess current extent of benthic habitats on Tetiaroa. 

For the health and trend scores, we will use the values for French Polynesia calculated in the Global Assessnent for 2020. 

***

#Data source

**Downloaded**: 07/10/2020

**Description**:  
French Polynesia Final Report
https://data.unep-wcmc.org/datasets/

[Insert better description here]

**Time range**: 2017

#Set up 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(pdftables)
library(here)

source(here('workflow/R/common.R'))

#file paths
goal     <- 'hab'
scenario <- 'v2020'
#dir_anx       <- file.path(dir_M, 'git-annex/globalprep') 
dir_goal      <- file.path(here('prep/bd',goal, scenario))
#dir_goal_anx  <- file.path(dir_anx, goal, scenario)
dir_github    <- '~/github/tet-prep'

pdf_api <- "yclryli65jdy"
```

Use pdftables to convert the data on page 21 of the pdf (do not re run this, since I cleaned in a bit in Excel)
```{r}

convert_pdf(file.path(dir_goal,"_raw_data/French-Polynesia-pg-21.pdf"), "fp_habtable.csv", api_key = pdf_api)

```

This worked - had to export and clean it up, resaved as fp_habtable_clean

```{r}
coral_table <- read_csv(here("prep/bd/hab/v2020/_raw_data", "fp_habtable_clean.csv")) %>% 
   mutate(
    area_km2 = as.numeric(Tetiaroa)
  ) %>% 
  dplyr::select(habitat, classification,  area_km2, -Tetiaroa)
 

```

## Find total coral extent

We can now find sums of each type of habitat. The classification also allows us to find coral / algae ratios.
```{r}

benthic_areas <- hab_table %>%
  filter(!is.na(area_km2)) %>% 
  group_by(classification) %>%
  summarize(
    tot_area_km2 = sum(area_km2)
  )
#export this as a csv, may be helpful to send to someone

write_csv(benthic_areas, file.path(dir_goal, "int","hab_benthic_total_area.csv"))

```

### Find the total area of coral cover in km2

We'll treat the categories that have the word "coral" or "reef" as area with coral cover
```{r}

coral_extent <- benthic_areas %>% 
  filter(str_detect(classification, pattern = "coral") | str_detect(classification, pattern = "reef")) %>% 
  summarize(
    km2 = sum(tot_area_km2)
  ) %>% 
  mutate(
    habitat = "coral",
    year = 2017,
    region_id = 1
  )


```

## Quantify coral health 

The global score for FP was one - just to compare, lets calculate the ratio of coral to macroalgea dominated areas

(note: check in report what lagoonal substrate is)