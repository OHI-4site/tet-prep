---
title: "OHI Tetiaroa: Coral Reef Habitat"
output:
  html_document:
    highlight: haddock
    includes:
      in_header: '~/github/tet-prep/workflow/templates/tet_hdr.html' 
    number_sections: yes
    theme: cerulean
    toc: yes
---

## Summary

This script pulls more up to date coral data from the Living Oceans Foundation French Polynesia report, which was published in 2017. This will be used to assess current extent of benthic habitats on Tetiaroa. 

For the health and trend scores, we will use the values for French Polynesia calculated in the Global Assessment for 2020. 

***

## Data source

**Downloaded**: 07/10/2020

**Description**:  

[Insert better description here]

**Time range**: 2017

## Set up 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(pdftables)
library(here)

source(here('workflow/R/common.R'))

#file paths
goal     <- 'hab'
scenario <- 'v2020'
#dir_anx       <- file.path(dir_M, 'git-annex/globalprep') 
dir_goal      <- file.path(here('prep/bd',goal, scenario))
#dir_goal_anx  <- file.path(dir_anx, goal, scenario)
dir_github    <- '~/github/tet-prep'

pdf_api <- "yclryli65jdy"
```

Use pdftables to convert the data on page 21 of the pdf (do not re run this, since I cleaned in a bit in Excel)
```{r}

convert_pdf(file.path(dir_goal,"_raw_data/French-Polynesia-pg-21.pdf"), "fp_habtable.csv", api_key = pdf_api)

```

This worked - had to export and clean it up, resaved as fp_habtable_clean

```{r}
coral_table <- read_csv(here("prep/bd/hab/v2020/_raw_data", "fp_habtable_clean.csv")) %>% 
   mutate(
    area_km2 = as.numeric(Tetiaroa)
  ) %>% 
  dplyr::select(habitat, classification,  area_km2, -Tetiaroa)
 

```

## Find total coral extent

We can now find sums of each type of habitat. The classification also allows us to find coral / algae ratios.
```{r}

benthic_areas <- hab_table %>%
  filter(!is.na(area_km2)) %>% 
  group_by(classification) %>%
  summarize(
    tot_area_km2 = sum(area_km2)
  )
#export this as a csv, may be helpful to send to someone

write_csv(benthic_areas, file.path(dir_goal, "int","hab_benthic_total_area.csv"))

```

### Find the total area of coral cover in km2

We'll treat the categories that have the word "coral" or "reef" as area with coral cover
```{r}

coral_extent <- benthic_areas %>% 
  filter(str_detect(classification, pattern = "coral") | str_detect(classification, pattern = "reef")) %>% 
  summarize(
    km2 = sum(tot_area_km2)
  ) %>% 
  mutate(
    habitat = "coral",
    year = 2017,
    region_id = 1
  )

write.csv(coral_extent, file = "~/github/tet-scores/region/layers/hab_coral_extent.csv", row.names = FALSE)
```

## Quantify coral health? 

Tricky because we don't know what it should be - ie how much coral there should be versus barren reef versus macro algae dominated. As a quick experiment, lets just find the ratio of coral to barren substrate is. There appears to be no marcoalgae dominated substrate in this survey.

```{r}

coral_algae_ratio <- benthic_areas %>% 
  filter(str_detect(classification, pattern = "substrate") | str_detect(classification, pattern = "Substrate")) %>% 
  summarize(
    km2 = sum(tot_area_km2)
  ) %>%
  mutate(
    habitat = "barren_substrate",
    year = 2017,
    region_id = 1
  ) %>%
  bind_rows(.,coral_extent) %>% 
  pivot_wider(
    names_from = habitat,
    values_from = km2
  ) %>% 
  mutate(
    health = coral/barren_substrate
  )

#so using this method health would only be 50%. Seems really uncertain and pretty low, so we'll stick with global for now. 


```

Instead we'll grab layers from global and filter by country (147)

```{r}

coral_health <- read_csv(here("prep/bd/hab/v2020/_raw_data", "hab_coral_health.csv")) %>% 
  filter(rgn_id == 147)

coral_trend <- read_csv(here("prep/bd/hab/v2020/_raw_data", "hab_coral_trend.csv")) %>%
  filter(rgn_id == 147)

  
```

Filter for French Polynesia

```{r}

coral_health_fp <- coral_health %>% 
  filter(rgn_id == 147)

coral_trend_fp <- coral_trend %>% 
  filter(rgn_id == 147) # do i need to make this for every year?

```

