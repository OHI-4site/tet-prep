---
title: '"Getting IUCN species for tet region"'
output: html_document
---

#Summary 

This script compares the shapefile of Tetiaroa and its surrounding waters to the species range map shapefiles from the IUCN to extract all the species in this area. Methods match `1_get_ne_iucn_spp.Rmd` by Jamie Montgomery, OHI Northeast, and also use data and code developed by Casey O'Hara: https://github.com/madelinemberger/spp_risk_dists.

#Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(raster)
library(rfishbase) #included in ne, may not need
library(rredlist)
library(taxize)
library(here)
library(tidyverse)

source(here('workflow/R/common.R'))

#tetiaroa region shape file
tet_shp <- tet_buffer_3nm


# api keys for IUCN 

api_file <- file.path(dir_M, 'git-annex/globalprep/spp', 
                      'api_key_gc.csv')
api_key <- scan(api_file, what = 'character')

```

#Methods

First step is to get a list of the cell IDs contained in the tet_region

```{r}

#these are global cell ids in raster format pulled from the spp_risk_dists repo.
cells <- raster("~/github/spp_risk_dists/_spatial/cell_id_rast.tif") #resolution is 10 km - is this too big? the area of this shp is 259 km2

#reproject shapefile to the same crs as the raster, which is WGS84

tet_reproj <- st_transform(tet_shp, crs = "+proj=cea +lon_0=0 +lat_ts=45 +x_0=0 +y_0=0 +ellps=WGS84
+units=m +no_defs")

plot(cells)
plot(tet_reproj, add = T)

#use extract to get the region ids for just the Tetiaroa area

tet_cells <- raster::extract(cells, tet_reproj) %>% 
  unlist() #this creates a vector out of the list from extract

```

Read in files that contain all the species ranges and information

```{r}

# .csv file that lists all species and the file path to their map
spp_maps <- read_csv('~/github/spp_risk_dists/_data/spp_marine_maps_2019-2.csv',
                     col_types = 'ddciccc')

#file with species information to link to iucn_sid at the end
spp_info <- read_csv("/home/ohara/git-annex/spp_risk_dists/iucn/spp_info_from_api_2019-2.csv")

```

The following forloop goes through each species:  
- finds it's species path
- reads in the species .csv that lists all global cells where it is found
- filters that list to just those in the Northeast
- returns an aggregated dataframe (`taxa_cells_df`) with all species scientific names, their unique ids (sids), and cellIDs

```{r}

#grab each taxa's folder filepath
taxa <- spp_maps$dbf_file %>% 
  unique() %>% 
  str_replace('\\....$', '')

#create an empty list that is the length of all taxa. We are going to fill this list  
taxa_cells_list <- vector('list', length = length(taxa))

#for each taxa, grab the species map (raster) and filter to only keep those cells in the northeast.
for(i in seq_along(taxa)) { ### i <- 5
    taxon <- taxa[i]
    print(i)
    spp_ids_in_taxon <- spp_maps %>%
      filter(str_detect(dbf_file, taxon)) %>%
      .$iucn_sid
    cat(sprintf('processing %s spp in %s...\n', length(spp_ids_in_taxon), taxon)) #help with this, message?
    
    spp_cells <- parallel::mclapply(spp_ids_in_taxon, mc.cores = 32,
                                    FUN = function(x) { ### x <- spp_ids_in_taxon[1]
                                      f <- file.path('/home/ohara/git-annex/spp_risk_dists/spp_rasters_2019',
                                                     sprintf('iucn_sid_%s.csv', x))
                                      if(file.exists(f)) {
                                        y <- read_csv(f, col_types = 'di') %>%
                                          mutate(iucn_sid = x) %>%
                                          select(-presence)  %>%
                                          filter(cell_id %in% tet_cells)
                                      } else {
                                        y <- data.frame(cell_id = NA,
                                                        iucn_sid = x, 
                                                        f = f, error = 'file not found')
                                      }
                                      return(y)
                                    }) %>%
      bind_rows() %>%
      mutate(spp_gp = taxon)
    
    taxa_cells_list[[i]] <- spp_cells
}

taxa_cells_list[[3]] #was using to just look at a few
taxa_cells_df <- taxa_cells_list %>%
    bind_rows() %>% 
    filter(!is.na(cell_id)) %>% 
    select(iucn_sid) %>% 
    distinct() %>%
    left_join(spp_info) #these all came out Na, so this df is empty 
```

Small note on looking at species maps - use filepath?
```{r}

humpback_whale <- spp_maps %>% 
  filter(iucn_sid == 13006)

plot(humpback_whale$dbf_file)
```

Attach common names

```{r}
#create list of scintific names of species

scinames <- taxa_cells_df$sciname

#create loop around redlist function rl_search to find common names  
#create empty data frame that will be filled
iucn_common_names <- data.frame() 

for(i in 1:length(scinames)){
  sp <- scinames[i]
  print(i)
  if(sp %in% c("Procelsterna cerulea")){ #this one threw some error and no $result was returned from rl_search
  comm <- NA
  }else{
  comm <- rredlist::rl_search(sp, key = api_key )$result$main_common_name
  }
  
  df <- data.frame(sciname = sp,
                   common = comm)
  
  iucn_common_names <- rbind(iucn_common_names, df) %>%
    mutate(common = as.character(common),
         sciname = as.character(sciname))
}

#had to remove blue noddy because it was causing an error

```

Check out the ones we are still missing for common name

```{r}

miss_sp <- sp <- iucn_common_names %>%
  filter(is.na(common))  %>%
  select(sciname)


fb_list <- species(miss_sp$sciname) %>% #this did not run
  select(Species, FBname)
```

